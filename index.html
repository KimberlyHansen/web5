<html>
	<head>
	
			<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		  crossorigin=""/>
	  
		 <!-- Make sure you put this AFTER Leaflet's CSS -->
		 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		   crossorigin=""></script>

        <!-- Load Esri Leaflet from CDN -->
		  <script src="https://unpkg.com/esri-leaflet@3.0.1/dist/esri-leaflet.js"
          integrity="sha512-JmpptMCcCg+Rd6x0Dbg6w+mmyzs1M7chHCd9W8HPovnImG2nLAQWn3yltwxXRM7WjKKFFHOAKjjF2SC4CgiFBg=="
          crossorigin=""></script>
          
        <!-- Load Leaflet MarkerCluster and Esri Leaflet Cluster from CDN -->
        <link rel="stylesheet" type="text/css"
          href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
          integrity="sha512-BBToHPBStgMiw0lD4AtkRIZmdndhB6aQbXpX7omcrXeG2PauGBl2lzq2xUZTxaLxYz5IDHlmneCZ1IJ+P3kYtQ=="
          crossorigin="">
        <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
          integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ=="
          crossorigin="">
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
          integrity="sha512-MQlyPV+ol2lp4KodaU/Xmrn+txc1TP15pOBF/2Sfre7MRsA/pB4Vy58bEqe9u7a7DczMLtU5wT8n7OblJepKbg=="
          crossorigin=""></script>
        <script src="https://unpkg.com/esri-leaflet-cluster@2.1.0/dist/esri-leaflet-cluster.js"
          integrity="sha512-fEdNFHisleVtEYdLhW4Z2RsR7TN6hLutE/+O4D+skfTNY2rlHm8HOZARPWkdrFFy/+i2KjFxcZAKTUWaVfbV0g=="
          crossorigin=""></script>

          <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		
	<!-- Load Esri Leaflet Geocoder from CDN -->
		
  		<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.css"
    		integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
   	 	crossorigin="">
  		<script src="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.js"
    		integrity="sha512-vZbMwAf1/rpBExyV27ey3zAEwxelsO4Nf+mfT7s6VTJPUbYmD2KSuTRXTxOFhIYqhajaBU+X5PuFK1QJ1U9Myg=="
    		crossorigin=""></script>

		 <style>  
			 #mapid { 
				height: 100%;
                                width: 100%;
			 }
			/* #mapid { height: 480px; } */
		 </style> 
	</head>
	<body>
	
		<div id="mapid"></div>
		
		<script>
        // Creating the map variable and setting zoom and coordinates to Ontario, Canada     
		var map = L.map('mapid').setView([51.2538, -85.3232], 5);
		
		L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYWp1dHppIiwiYSI6ImNrbGQ3d2E4MTE3cHAydXFlanJ1aG9maG4ifQ.6MOuQtvruOzh95-1C3i0jg', {
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
			maxZoom: 19,
			id: 'mapbox/streets-v11',
			tileSize: 512,
			zoomOffset: -1,
			accessToken: 'pk.eyJ1IjoiYWp1dHppIiwiYSI6ImNrbGQ3d2E4MTE3cHAydXFlanJ1aG9maG4ifQ.6MOuQtvruOzh95-1C3i0jg'
		}).addTo(map);
		
        // Creating variables for weather tile layers
        // OpenWeatherMap API tile reference: https://openweathermap.org/api/weathermaps
        // Leaflet tile reference: https://leafletjs.com/reference-1.7.1.html#tilelayer
        // Javascript 'new' operator reference: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/new
		var precip = (new L.TileLayer("http://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38")),
			weather = (new L.TileLayer("http://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38")),
			wind = (new L.TileLayer("http://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38")),
			clouds = (new L.TileLayer("http://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38")),
			pressure = (new L.TileLayer("http://tile.openweathermap.org/map/pressure_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38"));
		
		    
        // Key-value pairs used for the control panel 
        // Keys are the text values seen in the control panel, and the values are the corresponding tile layer variables
        // Layer groups and layers control tutorial: https://leafletjs.com/examples/layers-control/
		var overlayMaps = {
		"Precipitation" : precip,
		"Weather" : weather,
		"Wind" : wind,
		"Clouds" : clouds,
		"Pressure" : pressure
		};
		
        // Control panel in top left corner
        // Gives user the ability to toggle between different weather layers
		L.control.layers(overlayMaps).addTo(map);

        var trailheads = L.esri.Cluster.featureLayer({
			url: 'https://ws.lioservices.lrc.gov.on.ca/arcgis1071a/rest/services/LIO_OPEN_DATA/LIO_Open04/MapServer/20'
		}).addTo(map);

		trailheads.bindPopup(function (layer) {
			return L.Util.template('<p>Trail: <strong>{TRAIL_NAME}</strong><br>Association: {TRAIL_ASSO}<br>Website: {TRAIL_AS_1}<br>Activity: {ACTIVITY}<br>Description: <i>{DESCRIPTIO}</i><br> Length: <p>{LENGTH_KMS} <br>Difficulty: {OTC_TRAIL_}</p>', layer.feature.properties);
		});
		
		var trailPaths = L.esri.featureLayer({
			url: 'https://ws.lioservices.lrc.gov.on.ca/arcgis1071a/rest/services/LIO_OPEN_DATA/LIO_Open04/MapServer/19'
		}).addTo(map);
		
		trailPaths.bindPopup(function (layer) {
			return L.Util.template('<p><strong>{NAME}</strong></p>', layer.feature.properties);
		});

        // user gets weather data by clicking a location on the tile map
        map.on('click', function(layer){
		  var latlng = map.mouseEventToLatLng(layer.originalEvent);
		  console.log(latlng.lat + ', ' + latlng.lng);
		  //alert(latlng.lat + ' , ' + latlng.lng);
		  $.get( "https://api.openweathermap.org/data/2.5/weather?units=metric&lat="+latlng.lat+"&lon="+latlng.lng+"&appid=35b79f04000d801c24276115e7093f38", function( data ) {
			  console.log(data);
			  var weatherdata = JSON.stringify(data);
			  alert( "Data Loaded: " + weatherdata );
			});
		});
			
	// Geocoding for search //

		var searchControl = L.esri.Geocoding.geosearch({
    	position: 'topright',
    	placeholder: 'Where would you like to go?',
    	useMapBounds: false,
    	providers: [L.esri.Geocoding.arcgisOnlineProvider({
      	apikey: "AAPKb0ca0bbad2b54f9e95e3a84f0c93fa55Bthlfs8V3jANIB6Sxe9b2f1aoBAHWR9j07K021pFKJ60hj3eSSHb9pvAqsxDRuGt",
      	nearby: {
        lat: -33.8688,
        lng: 151.2093
      	}
    	})]
  	}).addTo(map);

  		var results = L.layerGroup().addTo(map);

  	searchControl.on('results', function (data) {
    	results.clearLayers();
    	for (var i = data.results.length - 1; i >= 0; i--) {
      	results.addLayer(L.marker(data.results[i].latlng));
    	}
  	});		

		
		</script>

	</body>
</html>
